# ============================================
# Railway Monorepo Configuration - Nixpacks
# Explicit paths & build verification
# ============================================

[build]
builder = "nixpacks"

[build.nixpacksPlan.phases.setup]
nixPkgs = ["nodejs-20_x", "npm-10_x"]

[build.nixpacksPlan.phases.install]
cmds = [
  "echo 'ğŸ“¦ Installing backend dependencies...'",
  "cd backend && npm ci && cd ..",
  "echo 'ğŸ“¦ Installing frontend dependencies...'",
  "npm ci"
]

[build.nixpacksPlan.phases.build]
cmds = [
  # Backend build
  "echo 'ğŸ”¨ Building backend (Prisma + TypeScript)...'",
  "cd backend && npm run build:prod && cd ..",

  # Backend build verification
  "echo 'ğŸ” Verifying backend build output...'",
  "ls -la backend/dist/ || echo 'âš ï¸  backend/dist/ not found!'",
  "test -f backend/dist/index.js || (echo 'âŒ ERROR: backend/dist/index.js not found!' && exit 1)",
  "echo 'âœ… Backend build verified: backend/dist/index.js exists'",

  # Find all compiled JS files (debug)
  "echo 'ğŸ“„ Compiled backend files:'",
  "find backend/dist -maxdepth 2 -name '*.js' -type f | head -10",

  # Frontend build
  "echo 'ğŸ”¨ Building frontend (Vite)...'",
  "npm run build",

  # Frontend build verification
  "echo 'ğŸ” Verifying frontend build output...'",
  "ls -la dist/ || echo 'âš ï¸  dist/ not found!'",
  "test -f dist/index.html || (echo 'âŒ ERROR: dist/index.html not found!' && exit 1)",
  "echo 'âœ… Frontend build verified: dist/index.html exists'"
]

[deploy]
# Explicit start command - no cd, absolute path from /app
startCommand = "node backend/dist/index.js"
healthcheckPath = "/health"
healthcheckTimeout = 200
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 10

# ============================================
# Environment Variables (Railway UI'dan ekle)
# ============================================
# DATABASE_URL=postgresql://...
# NODE_ENV=production
# JWT_SECRET=<64-char-random>
# JWT_EXPIRES_IN=7d
#
# âš ï¸  PORT eklemeyin! Railway otomatik saÄŸlar.
